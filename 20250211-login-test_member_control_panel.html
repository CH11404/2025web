<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>會員專區</title>
  <link rel="stylesheet" href="css/bootstrap.min.css">
  <link rel="stylesheet" href="css/all.min.css">
  <link rel="stylesheet" href="css/mycss.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
  <style>
    /* 與產品管理介面相同的配色設定 */
    body {
      background-color: var(--mycolor14);
    }

    .navbar {
      background-color: var(--mycolor10);
    }

    .navbar-brand,
    .nav-link {
      color: var(--mycolor13) !important;
    }

    .nav-link.active {
      font-weight: bold;
    }

    /* 表格相關設定 */
    .table {
      background-color: var(--mycolor01);
    }

    .table thead {
      background-color: var(--mycolor13);
      color: #ffffff;
    }

    .table-bordered,
    .table-bordered th,
    .table-bordered td {
      border: 2px solid var(--mycolor13) !important;
    }

    .table td,
    .table th {
      text-align: center;
      vertical-align: middle;
    }

    /* 按鈕樣式 */
    .btn-primary {
      background-color: var(--mycolor13);
      border-color: var(--mycolor13);
    }

    .btn-warning {
      background-color: var(--mycolor12);
      border-color: var(--mycolor12);
      color: #fff;
    }

    .btn-danger {
      background-color: var(--mycolor07);
      border-color: var(--mycolor07);
    }

    /* Modal 樣式 */
    .modal-header {
      background-color: var(--mycolor13);
      color: #ffffff;
    }

    .discount-card .card-header {
      background-color: var(--mycolor13);
      color: #fff;
    }

    .discount-card {
      background-color: var(--mycolor01);
      border: 2px solid var(--mycolor13)
    }

    /* 統計圖表容器 */
    .chart-container {
      padding: 1rem;
    }

    /* 購買紀錄區塊樣式 */
    #purchase_records_section h4 {
      color: var(--mycolor13);
    }
  </style>
</head>

<body>
  <!-- 上方 Navbar -->
  <section id="s02" class="bg-010">
    <div class="container">
      <nav class="navbar navbar-expand-lg">
        <div class="container-fluid">
          <a class="navbar-brand" href="#">
            <i class="fa-solid fa-circle-user fa-1x m-auto" style="color: var(--mycolor13);"></i>
            <span style="color: var(--mycolor13); letter-spacing: 0.1em;">會員專區</span>
          </a>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
            data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false"
            aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
          </button>
          <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav me-auto mb-2 mb-lg-0">
              <li class="nav-item">
                <a class="nav-link active" href="20250211-login-test.html">首頁</a>
              </li>
              <li class="nav-item">
                <a class="nav-link active" href="/member3fun.html">獨享優惠</a>
              </li>
              <li class="nav-item">
                <a class="nav-link active" href="/member45fun.html">專屬配送</a>
              </li>
              <li class="nav-item">
                <a class="nav-link active" href="/member5fun.html">限定活動</a>
              </li>
            </ul>
            <div>
              <span class="h5 px-3 py-1 rounded-3" style="color: white; 
                      background: linear-gradient(45deg, var(--mycolor04), #ff6b6b);
                      box-shadow: 0 2px 5px rgba(0,0,0,0.1);" id="s02_username_text">XXX</span>
              <button class="btn bg-013 d-none ms-3" data-bs-toggle="modal" data-bs-target="#logoutModal"
                id="s02_logout_btn">
                <span style="color: whitesmoke;">登出</span>
              </button>
            </div>
          </div>
        </div>
      </nav>
    </div>
  </section>

  <!-- 主內容：會員資料列表 -->
  <div class="container my-5">
    <div class="row">
      <div class="col-12">
        <table class="table table-bordered table-hover shadow-lg table-rwd">
          <thead>
            <tr>
              <th>編號</th>
              <th>帳號</th>
              <th>Email</th>
              <th>地址</th>
              <th>身份</th>
              <th>會員等級</th>
              <th>註冊時間</th>
              <th>功能</th>
            </tr>
          </thead>
          <tbody id="mydata">
            <!-- 資料將由 JavaScript 動態插入 -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- 會員等級說明與優惠碼並排 -->
    <div class="container my-4">
      <div class="row">
        <!-- 會員等級說明區 -->
        <div class="col-md-4">
          <div class="card shadow-lg" style="border: 2px solid var(--mycolor13);">
            <div class="card-header" style="background-color: var(--mycolor13); color: #fff;">
              <h4 class="mb-0"><i class="fa-solid fa-star me-2"></i>會員等級說明</h4>
            </div>
            <div class="card-body" style="background-color: var(--mycolor01);">
              <p class="card-text">
                會員等級根據您的訂單數量累積。<br> 每完成 5 筆訂單即可升級，最高可達 5 級。
              </p>
              <hr style="color: var(--mycolor13);">
              <table class="table table-borderless">
                <tbody>
                  <tr>
                    <th style="width: 40%; color: var(--mycolor13);">目前等級</th>
                    <td id="current_level" style="font-weight: bold;"></td>
                  </tr>
                  <tr>
                    <th style="color: var(--mycolor13);">訂單數量</th>
                    <td id="order_count" style="font-weight: bold;"></td>
                  </tr>
                </tbody>
              </table>
              <hr>
              <div class="mt-3">
                <div class="d-flex justify-content-between">
                  <span style="color: var(--mycolor13);">升級進度</span>
                  <small id="progress_text" class="text-muted"></small>
                </div>
                <div class="progress mt-2" style="height: 25px;">
                  <div class="progress-bar progress-bar-striped progress-bar-animated" id="level_progress"
                    role="progressbar" style="width: 0%; background-color: var(--mycolor13);" aria-valuemin="0"
                    aria-valuemax="100"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <!-- 會員優惠碼顯示區 -->
        <div class="col-md-4">
          <div class="card shadow-lg discount-card" id="discount_card">
            <div class="card-header" id="discount_header">
              <h4 class="mb-0"><i class="fa-solid fa-tag me-2"></i>我的優惠碼</h4>
            </div>
            <div class="card-body" id="discount_body">
              <!-- 優惠碼與複製按鈕並排 -->
              <div class="d-flex align-items-center justify-content-between">
                <p id="discount_info" class="mb-0" style="font-size: 1.5em; font-weight: bold;">載入中...</p>
                <button id="copy_coupon_code" class="btn ms-2"
                  style="background-color: var(--mycolor13); border-color: var(--mycolor13); color: #fff;">
                  複製
                </button>
              </div>
              <hr style="border-top: 2px solid var(--mycolor13);">
              <!-- 額外資訊 -->
              <div class="discount-details" style="font-size: 1.25em;">
                <p class="mb-1">(每月可使用一張)</p>
                <ul class="list-unstyled mb-0">
                  <li>LV1: 9折優惠</li>
                  <li>LV2: 85折優惠</li>
                  <li>LV3: 8折優惠</li>
                  <li>LV4: 75折優惠</li>
                  <li>LV5: 7折優惠</li>
                </ul>
              </div>
            </div>
          </div>
        </div>
        <!-- 右側：統計圖表卡片 -->
        <div class="col-12 col-md-4">
          <div class="card discount-card shadow-lg">
            <div class="card-header">
              <h4 class="mb-0"><i class="fa-solid fa-chart-line me-2"></i>
                <!-- 依據登入角色變更標題 -->
                <span id="chart_title">統計圖表</span>
              </h4>
            </div>
            <div class="card-body" id="chart_body" style="background-color: var(--mycolor01);">
              <div class="chart-container">
                <canvas id="statChart"></canvas>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- 買家購買紀錄區（僅針對買家顯示） -->
    <div id="purchase_records_section" class="container my-4" style="display: none;">
      <h4 class="mb-3">購買紀錄</h4>
      <table class="table table-bordered table-hover shadow-lg table-rwd">
        <thead>
          <tr>
            <th>商品名稱</th>
            <th>類別</th>
            <th>總額</th>
            <th>購買日期</th>
          </tr>
        </thead>
        <tbody id="purchase_records">
          <!-- 購買紀錄資料由 JavaScript 動態插入 -->
        </tbody>
      </table>
    </div>



    <!-- updateModal -->
    <div class="modal fade" id="updateModal" tabindex="-1" aria-labelledby="updateModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="updateModalLabel">會員更新</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label for="updateModal_username">帳號</label>
              <input type="text" class="form-control" id="updateModal_username" disabled>
            </div>
            <div class="mb-3">
              <label for="updateModal_email">Email</label>
              <input type="text" class="form-control" id="updateModal_email">
              <div class="valid-feedback">符合規則</div>
              <div class="invalid-feedback">不符合規則</div>
            </div>
            <div class="mb-3">
              <label for="updateModal_address">地址</label>
              <input type="text" class="form-control" id="updateModal_address">
              <div class="valid-feedback">符合規則</div>
              <div class="invalid-feedback">不符合規則</div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
            <button type="button" class="btn btn-primary" id="updateModal_update_btn">確認更新</button>
          </div>
        </div>
      </div>


      <script src="js/bootstrap.bundle.min.js"></script>
      <script src="js/jquery-3.7.1.min.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
      <script src="js/cookie.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

      <script>
        var u_id; // 用於更新時記錄會員ID
        var flag_updateModal_email = true;
        var flag_updateModal_address = true;

        // 檢查 uid 並渲染資料
        if (getCookie("Uid01")) {
          var JSONdata = { "uid01": getCookie("Uid01") };
          $.ajax({
            type: "POST",
            url: "20250211-webcontrol-.api.php?action=checkuid",
            data: JSON.stringify(JSONdata),
            dataType: "json",
            success: function (data) {
              if (data.state) {
                $("#s02_username_text").text(data.data.Username);
                $("#s02_logout_btn").removeClass("d-none");

                // 取得並顯示會員資料
                $.ajax({
                  type: "GET",
                  url: "20250211-webcontrol-.api.php?action=getalldata&uid01=" + getCookie("Uid01"),
                  dataType: "json",
                  success: function (response) {
                    $("#mydata").empty();
                    if (response.data) {
                      var item = response.data;
                      var strHTML = `
                    <tr>
                      <td data-th="編號">${item.User_id}</td>
                      <td data-th="帳號">${item.Username}</td>
                      <td data-th="Email">${item.Email}</td>
                      <td data-th="地址">${item.Address}</td>
                      <td data-th="身份">${item.role}</td>
                      <td data-th="會員等級">${item.discount_level}</td>
                      <td data-th="註冊時間">${item.Create_at}</td>
                      <td data-th="功能">
                        <button class="btn btn-warning update-btn" data-bs-target="#updateModal" data-bs-toggle="modal" data-id="${item.User_id}" data-username="${item.Username}" data-email="${item.Email}" data-address="${item.Address}">更新</button>
                        <button class="btn btn-danger delete-btn" data-id="${item.User_id}">刪除</button>
                      </td>
                    </tr>
                  `;

                      // 若為買家，顯示購買紀錄區並載入訂單資料
                      if (item.role === "buyer") {
                        $("#purchase_records_section").show();
                        $.ajax({
                          type: "GET",
                          url: "20250211-webcontrol-.api.php?action=order_list&uid01=" + getCookie("Uid01"),
                          dataType: "json",
                          success: function (orderResponse) {
                            $("#purchase_records").empty();
                            if (orderResponse.state && orderResponse.data.length > 0) {
                              orderResponse.data.forEach(function (order) {
                                var orderHTML = `
                                    <tr>
                                      <td>${order.product_name}</td>
                                      <td>${order.product_category}</td>
                                      <td>${order.total_amount}</td>
                                      <td>${order.order_date}</td>
                                    </tr>
                                  `;
                                $("#purchase_records").append(orderHTML);
                              });
                            } else {
                              $("#purchase_records").html("<tr><td colspan='4'>無購買紀錄</td></tr>");
                            }
                          },
                          error: function () {
                            $("#purchase_records").html("<tr><td colspan='4'>取得購買紀錄失敗</td></tr>");
                          }
                        });
                      }


                      $("#mydata").append(strHTML);

                      // 依據訂單數量計算會員等級與進度
                      var orders = parseInt(item.order_count);
                      var level = orders > 0 ? Math.min(5, Math.ceil((orders + 1) / 5)) : 1;
                      var lowerBound = (level - 1) * 5;
                      var upperBound = level * 5;
                      var progressPercent = ((orders - lowerBound) / (upperBound - lowerBound)) * 100;
                      if (level === 5 && orders >= 20) {
                        progressPercent = 100;
                        $("#progress_text").text("您已達到最高等級！");
                      } else {
                        $("#progress_text").text("再訂購 " + (upperBound - orders) + " 筆訂單即可升級");
                      }
                      $("#current_level").text(level);
                      $("#order_count").text(orders);
                      $("#level_progress").css("width", progressPercent + "%");

                      if (level < 3) {
                        $('a[href="/member3fun.html"]').hide();
                        $('a[href="/member45fun.html"]').hide();
                        $('a[href="/member5fun.html"]').hide();
                      } else if (level < 4) {
                        $('a[href="/member45fun.html"]').hide();
                        $('a[href="/member5fun.html"]').hide();
                      } else if (level < 5) {
                        $('a[href="/member5fun.html"]').hide();
                      }

                      $.ajax({
                        type: "GET",
                        url: "20250211-webcontrol-.api.php?action=discount&uid01=" + getCookie("Uid01"),
                        dataType: "json",
                        success: function (discData) {
                          if (discData.state) {
                            var discountCode = discData.data.discount_code;
                            $("#discount_info").text(discountCode);
                            // 根據會員等級設定優惠碼卡片的樣式
                            $("#discount_card").removeClass("level-1 level-2 level-3 level-4 level-5").addClass("level-" + item.discount_level);
                          } else {
                            $("#discount_info").text("無法取得優惠碼");
                          }
                        },
                        error: function () {
                          $("#discount_info").text("API錯誤");
                        }
                      });
                    } else {
                      $("#mydata").append("<tr><td colspan='8'>沒有會員資料</td></tr>");
                    }
                  },
                  error: function () {
                    Swal.fire({
                      title: "API介接錯誤",
                      text: "無法取得會員資料",
                      icon: "error"
                    });
                  }
                });
              } else {
                Swal.fire({
                  title: "驗證失敗",
                  icon: "error"
                });
              }
            },
            error: function () {
              Swal.fire({
                title: "API介接錯誤",
                text: "20250211-webcontrol-.api.php?action=checkuid",
                icon: "error"
              });
            }
          });
        } else {
          Swal.fire({
            title: "請先登入會員",
            icon: "info",
            allowOutsideClick: false
          }).then(function () {
            location.href = "20250211-login-test.html";
          });
        }

        var uid = getCookie("Uid01");
        // 取得統計資料
        $.ajax({
          type: "GET",
          url: "20250211-webcontrol-.api.php?action=chart_data&uid01=" + uid,
          dataType: "json",
          success: function (response) {
            if (response.state) {
              var data = response.data;
              // 判斷返回資料格式：若第一筆資料有 month 屬性，代表為賣家；若有 category 屬性，則為買家。
              if (data.length > 0 && data[0].month !== undefined) {
                renderSellerChart(data);
              } else if (data.length > 0 && data[0].category !== undefined) {
                renderBuyerChart(data);
              } else {
                $("#statChart").replaceWith("<p>無統計數據</p>");
              }
            } else {
              alert("取得統計資料失敗：" + response.message);
            }
          },
          error: function (xhr, status, error) {
            console.error("取得統計資料錯誤：", status, error);
          }
        });


        // 賣家：顯示折線圖（近期每月銷售量）
        function renderSellerChart(data) {
          var labels = [];
          var salesData = [];
          data.forEach(function (item) {
            labels.push(item.month);
            salesData.push(item.sales);
          });
          var ctx = document.getElementById('statChart').getContext('2d');
          var chart = new Chart(ctx, {
            type: 'line',
            data: {
              labels: labels,
              datasets: [{
                label: '近期銷售量',
                data: salesData,
                backgroundColor: 'rgba(99, 31, 22, 0.2)',
                borderColor: 'rgb(99, 31, 22)',
                borderWidth: 2,
                fill: true
              }]
            },
            options: {
              responsive: true,
              scales: {
                y: {
                  beginAtZero: true,
                  ticks: {
                    stepSize: 1
                  }
                }
              }
            }
          });
        }

        // 買家：顯示圓餅圖（近期購買的書籍類型比例）
        function renderBuyerChart(data) {
          var labels = [];
          var counts = [];
          data.forEach(function (item) {
            labels.push(item.category);
            counts.push(item.count);
          });
          var ctx = document.getElementById('statChart').getContext('2d');
          var chart = new Chart(ctx, {
            type: 'pie',
            data: {
              labels: labels,
              datasets: [{
                label: '購買類型比例',
                data: counts,
                backgroundColor: [
                  'rgba(99, 31, 22, 0.6)',
                  'rgba(255, 183, 77, 0.6)',
                  'rgba(129, 212, 250, 0.6)',
                  'rgba(174, 213, 129, 0.6)',
                  'rgba(244, 143, 177, 0.6)',
                  'rgba(255, 238, 88, 0.6)'
                ],
                borderColor: [
                  'rgb(99, 31, 22)',
                  'rgb(255, 183, 77)',
                  'rgb(129, 212, 250)',
                  'rgb(174, 213, 129)',
                  'rgb(244, 143, 177)',
                  'rgb(255, 238, 88)'
                ],
                borderWidth: 1
              }]
            },
            options: {
              responsive: true
            }
          });
        }

        // 更新按鈕事件（使用事件代理）
        $(document).on("click", ".update-btn", function () {
          u_id = $(this).data("id");
          $("#updateModal_username").val($(this).data("username"));
          $("#updateModal_email").val($(this).data("email"));
          $("#updateModal_address").val($(this).data("address"));
        });

        // 刪除按鈕事件
        $(document).on("click", ".delete-btn", function () {
          var id = $(this).data("id");
          Swal.fire({
            title: "確認刪除使用者?",
            showDenyButton: true,
            confirmButtonText: "確認",
            denyButtonText: "取消",
            allowOutsideClick: false
          }).then(function (result) {
            if (result.isConfirmed) {
              $.ajax({
                type: "DELETE",
                url: "20250211-webcontrol-.api.php?action=delete",
                data: JSON.stringify({ "id": id }),
                dataType: "json",
                success: function (data) {
                  if (data.state) {
                    Swal.fire("成功", data.message, "success").then(function () {
                      location.reload();
                    });
                  } else {
                    Swal.fire("錯誤", data.message, "error");
                  }
                },
                error: function () {
                  Swal.fire("API介接錯誤", "請檢查API", "error");
                }
              });
            }
          });
        });

        // 監聽更新 Modal 中的確認更新按鈕
        $("#updateModal_update_btn").click(function () {
          if (flag_updateModal_email && flag_updateModal_address) {
            var JSONdata = {
              "id": u_id,
              "email": $("#updateModal_email").val(),
              "address": $("#updateModal_address").val()
            };
            $.ajax({
              type: "POST",
              url: "20250211-webcontrol-.api.php?action=update",
              data: JSON.stringify(JSONdata),
              contentType: "application/json",
              dataType: "json",
              success: function (data) {
                if (data.state) {
                  Swal.fire("成功", data.message, "success").then(function () {
                    location.reload();
                  });
                } else {
                  Swal.fire("錯誤", data.message, "error");
                }
              },
              error: function () {
                Swal.fire("API介接錯誤", "請檢查API", "error");
              }
            });
          } else {
            Swal.fire("欄位內容有誤", "", "error");
          }
        });

        // 及時監聽更新 Modal 輸入欄位
        $("#updateModal_email").on("input propertychange", function () {
          if ($(this).val().length > 2 && $(this).val().length < 17) {
            $(this).removeClass("is-invalid").addClass("is-valid");
            flag_updateModal_email = true;
          } else {
            $(this).removeClass("is-valid").addClass("is-invalid");
            flag_updateModal_email = false;
          }
        });
        $("#updateModal_address").on("input propertychange", function () {
          if ($(this).val().length > 2 && $(this).val().length < 27) {
            $(this).removeClass("is-invalid").addClass("is-valid");
            flag_updateModal_address = true;
          } else {
            $(this).removeClass("is-valid").addClass("is-invalid");
            flag_updateModal_address = false;
          }
        });

        $("#copy_coupon_code").click(function () {
          var couponCode = $("#discount_info").text();

          // 如果支援 Clipboard API
          if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(couponCode).then(function () {
              Swal.fire({
                title: "已複製優惠券代碼",
                icon: "success",
                timer: 1500,
                showConfirmButton: false
              });
            }).catch(function (err) {
              Swal.fire({
                title: "複製失敗",
                text: err,
                icon: "error"
              });
            });
          } else {
            // 備援：使用 document.execCommand
            var $temp = $("<input>");
            $("body").append($temp);
            $temp.val(couponCode).select();
            try {
              var successful = document.execCommand("copy");
              if (successful) {
                Swal.fire({
                  title: "已複製優惠券代碼",
                  icon: "success",
                  timer: 1500,
                  showConfirmButton: false
                });
              } else {
                throw new Error("執行複製命令失敗");
              }
            } catch (err) {
              Swal.fire({
                title: "複製失敗",
                text: err,
                icon: "error"
              });
            }
            $temp.remove();
          }
        });




        // 登出按鈕
        $("#s02_logout_btn").click(function () {
          setCookie("Uid01", "", 7);
          location.href = "20250211-login-test.html";
        });
      </script>
</body>

</html>